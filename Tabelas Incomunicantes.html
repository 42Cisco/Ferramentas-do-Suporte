<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Organizador de Placas – Multiempresa (Abas)</title>
<style>
  :root {
    --bg:#f8fafc; --panel:#fff; --muted:#64748b; --border:#e2e8f0; --panel-2:#f1f5f9;
    --accent:#059669; --accent-2:#047857; --danger:#e11d48; --danger-2:#be123c;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#0f172a;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1280px;margin:24px auto;padding:0 16px}
  h1{font-size:24px;margin:0 0 4px}
  .muted{color:var(--muted);font-size:13px}
  .row{display:grid;gap:16px;grid-template-columns:1fr}
  @media (min-width:900px){.row{grid-template-columns:1fr 1fr}}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  textarea,input[type="text"],input[type="file"],input[type="date"]{width:100%;border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#fff;outline:none}
  textarea:focus,input[type="text"]:focus,input[type="date"]:focus{box-shadow:0 0 0 3px #cbd5e1}
  .btn{appearance:none;border:0;border-radius:999px;padding:10px 14px;font-size:14px;background:#fff;border:1px solid var(--border);box-shadow:0 1px 2px rgba(0,0,0,.06);cursor:pointer}
  .btn:hover{background:#f8fafc}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn.primary:hover{background:var(--accent-2)}
  .btn.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
  .btn.danger:hover{background:var(--danger-2)}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px}

  /* abas */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .tab{padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:999px;cursor:pointer}
  .tab.active{background:#111827;color:#fff;border-color:#111827}

  .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:16px;background:#fff}
  table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px}
  thead th{position:sticky;top:0;background:var(--panel-2);z-index:2;text-align:left;padding:8px 12px;border-bottom:1px solid var(--border)}
  thead .sub th{top:36px;background:#fff}
  tbody td {
  padding:8px 12px;
  border-top:1px solid #f1f5f9;
  vertical-align: top !important; /* ⬅ isso corrige o texto afundado */
  line-height: 1.2; /* opcional: deixa o texto mais equilibrado */
}

  .col-grupo      { min-width: 160px; }
  .col-placa      { min-width: 100px; text-align:center; }
  .col-posicao    { min-width: 140px; text-align:center; }
  .col-endereco   { min-width: 420px; white-space: normal; line-height: 1.1; }
  .col-equip      { min-width: 100px; text-align:center; }
  .col-area       { min-width: 110px; text-align:center; }

  .sepL { border-left: 3px solid #94a3b8 !important; }
  .gutter { width: 12px; min-width: 12px; background: #e2e8f0; padding: 0; }

  th.wk-sub.wk-0, td.wk.wk-0 { background: #f8fafc; }
  th.wk-sub.wk-1, td.wk.wk-1 { background: #f1f5ff; }

  .weekhead{display:flex;align-items:center;gap:6px}
  .weekhead input[type="text"]{width:220px;padding:6px 8px;font-size:12px}
  .weekhead .btn{padding:4px 8px;font-size:12px}
</style>
</head>
<body>
  <div class="wrap">

    <!-- Abas -->
    <div class="tabs" id="tabs"></div>
    <div class="toolbar" style="margin-bottom:12px;">
      <button id="btnAddCompany" class="btn">+ Nova empresa</button>
      <button id="btnRenameCompany" class="btn">Renomear</button>
      <button id="btnDeleteCompany" class="btn danger">Excluir empresa</button>
    </div>

    <header class="card" style="display:flex;align-items:end;justify-content:space-between;gap:12px;">
      <div>
        <h1>Organizador de Placas <span id="companyTitle" class="muted"></span></h1>
        <div class="muted">Cole o CSV/TSV da semana (ex.: <code>GRUPO,PLACA,POSIÇÃO SERV,ENDEREÇO,EQUIPAMENTO[,ÁREA]</code>). Aceita TAB, ;, , ou múltiplos espaços. Com ou sem cabeçalho.</div>
      </div>
      <div class="toolbar">
        <button id="btnExportCsv" class="btn">Exportar CSV (todas)</button>
        <button id="btnExportXls" class="btn">Exportar Excel (todas)</button>
        <button id="btnReset" class="btn danger">Limpar empresa</button>
      </div>
    </header>

    <section class="row">
      <div class="card">
        <label class="muted">Cole aqui o <b>CSV/TSV da semana</b>.</label>
        <textarea id="txtPaste" rows="8" placeholder="GRUPO,PLACA,POSIÇÃO SERV,ENDEREÇO,EQUIPAMENTO[,ÁREA]
VEÍCULOS BALCÃO	JAM5J05	23/06/2024 03:10	Rua Pastor Heinrich...	GV50
..."></textarea>
        <div class="dates" style="margin-top:8px;display:flex;gap:8px;align-items:end;">
          <div>
            <label class="muted" style="display:block;font-size:12px;">Início</label>
            <input id="dtStart" type="date" />
          </div>
          <div>
            <label class="muted" style="display:block;font-size:12px;">Fim</label>
            <input id="dtEnd" type="date" />
          </div>
          <input id="inpWeekLabel" type="text" placeholder="dd/mm/aaaa a dd/mm/aaaa" style="flex:1;" />
          <button id="btnAddWeek" class="btn primary">Adicionar semana (CSV)</button>
        </div>
        <div class="muted" style="margin-top:6px;">Rótulo no padrão <b>dd/mm/aaaa</b>. Pode digitar ou escolher no calendário.</div>
      </div>

      <div class="card">
        <label class="muted">Filtrar por placa:</label>
        <input id="inpFilter" type="text" placeholder="Digite parte da placa…" />
        <div id="stats" class="muted" style="margin-top:6px;">—</div>
      </div>
    </section>

    <section class="table-wrap" style="margin-top:16px;">
      <table id="grid">
        <thead>
          <tr id="headRow"></tr>
          <tr id="subHeadRow" class="sub"></tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
    </section>

    <footer class="muted" style="margin-top:12px;">
      Abas independentes por empresa. Linhas fixas (com suporte a placas repetidas), coluna opcional <b>ÁREA</b>, e exportações CSV/XLSX por semana e gerais.
    </footer>
  </div>

  <!-- XLSX com fallback de CDN -->
  <script
    src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"
    onerror="(function(){var s=document.createElement('script');s.src='https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js';document.head.appendChild(s)})();"
  ></script>

<script>
(function(){
  /* ====== MULTI-EMPRESA (ABAS) ====== */
  const LS_GLOBAL = 'op_companies_v1'; // { companies:[], current:'' }

  function loadCompanies(){
    try{
      const j = JSON.parse(localStorage.getItem(LS_GLOBAL)||'{}');
      if (j && Array.isArray(j.companies) && j.companies.length) return j;
      const def = { companies: ['PAP','TIMBER','BETIOLO'], current: 'PAP' };
      localStorage.setItem(LS_GLOBAL, JSON.stringify(def));
      return def;
    }catch(_){
      const def = { companies: ['PAP','TIMBER','BETIOLO'], current: 'PAP' };
      localStorage.setItem(LS_GLOBAL, JSON.stringify(def));
      return def;
    }
  }
  function saveCompanies(obj){ localStorage.setItem(LS_GLOBAL, JSON.stringify(obj)); }
  function getLSKeys(company){
    const prefix = `op_${company}_`;
    return {
      plates: prefix + 'plates_master_v4',
      weeks:  prefix + 'weeks_v4',
      names:  prefix + 'key_display_v1'
    };
  }

  let { companies, current } = loadCompanies();
  const tabsEl = document.getElementById('tabs');
  const companyTitleEl = document.getElementById('companyTitle');

  function loadStateFor(company){
    const K = getLSKeys(company);
    try{
      masterPlates = JSON.parse(localStorage.getItem(K.plates)||'[]') || [];
      weeks        = JSON.parse(localStorage.getItem(K.weeks)||'[]')  || [];
      displayName  = JSON.parse(localStorage.getItem(K.names)||'{}')  || {};
    }catch(_){
      masterPlates = []; weeks = []; displayName = {};
    }
  }
  function persist(){
    const K = getLSKeys(current);
    localStorage.setItem(K.plates, JSON.stringify(masterPlates));
    localStorage.setItem(K.weeks,  JSON.stringify(weeks));
    localStorage.setItem(K.names,  JSON.stringify(displayName));
  }

  // === RENDER DAS ABAS (corrigido: fecha chaves e adiciona appendChild)
  function renderTabs(){
    tabsEl.innerHTML = '';
    companies.forEach(name=>{
      const b = document.createElement('button');
      b.className = 'tab' + (name===current?' active':'');
      b.textContent = name;
      b.addEventListener('click', ()=>{
        current = name;
        saveCompanies({companies, current});
        loadStateFor(current);
        renderTabs();
        render();
      });
      tabsEl.appendChild(b); // <- faltava
    });
    companyTitleEl.textContent = `— ${current}`;
  }

  // === Helpers para nomes de abas (fora de renderTabs)
  const normName = (s) => (s || '')
    .toString()
    .trim()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .toUpperCase();

  const existsCompany = (arr, name, skipIndex = -1) =>
    arr.some((c, i) => i !== skipIndex && normName(c) === normName(name));

  // + Nova empresa (sem duplicar save e com normalização)
  document.getElementById('btnAddCompany').addEventListener('click', ()=>{
    const name = prompt('Nome da nova empresa (aba):');
    if (!name) return;
    const n = name.trim();
    if (!n) return;

    if (existsCompany(companies, n))
      return alert('Já existe uma aba com esse nome.');

    companies.push(n);
    current = n;

    const K = getLSKeys(n);
    localStorage.setItem(K.plates, JSON.stringify([]));
    localStorage.setItem(K.weeks,  JSON.stringify([]));
    localStorage.setItem(K.names,  JSON.stringify({}));

    saveCompanies({ companies, current });
    loadStateFor(current);
    renderTabs();
    render();
  });

  // Renomear (com colisão segura)
  document.getElementById('btnRenameCompany').addEventListener('click', ()=>{
    const idx = companies.indexOf(current);
    if (idx < 0) return;

    const novo = prompt('Novo nome da empresa:', current);
    if (!novo) return;
    const newName = novo.trim();
    if (!newName) return;

    if (normName(newName) === normName(current)) return;
    if (existsCompany(companies, newName, idx))
      return alert('Já existe uma aba com esse nome.');

    const oldK = getLSKeys(current);
    const plates = localStorage.getItem(oldK.plates);
    const weeks  = localStorage.getItem(oldK.weeks);
    const names  = localStorage.getItem(oldK.names);

    const newK = getLSKeys(newName);
    if (plates !== null) localStorage.setItem(newK.plates, plates);
    if (weeks  !== null) localStorage.setItem(newK.weeks,  weeks);
    if (names  !== null) localStorage.setItem(newK.names,  names);

    localStorage.removeItem(oldK.plates);
    localStorage.removeItem(oldK.weeks);
    localStorage.removeItem(oldK.names);

    companies[idx] = newName;
    current = newName;

    saveCompanies({ companies, current });
    loadStateFor(current);
    renderTabs();
    render();
  });

  // Excluir empresa
  document.getElementById('btnDeleteCompany').addEventListener('click', ()=>{
    if (!confirm(`Excluir a empresa "${current}"?`)) return;

    const idx = companies.indexOf(current);
    if (idx < 0) return;

    const K = getLSKeys(current);
    localStorage.removeItem(K.plates);
    localStorage.removeItem(K.weeks);
    localStorage.removeItem(K.names);

    companies.splice(idx, 1);
    if (!companies.length) {
      companies = ['GERAL'];
      current = 'GERAL';
      const K2 = getLSKeys(current);
      localStorage.setItem(K2.plates, JSON.stringify([]));
      localStorage.setItem(K2.weeks,  JSON.stringify([]));
      localStorage.setItem(K2.names,  JSON.stringify({}));
    } else {
      current = companies[Math.max(0, idx - 1)];
    }

    saveCompanies({ companies, current });
    loadStateFor(current);
    renderTabs();
    render();
  });

  /* ====== ESTADO POR EMPRESA ====== */
  const norm = (s)=> (s||'').toString().trim().toUpperCase();
  const pad = (n)=> String(n).padStart(2,'0');
  const fmtBR = (d)=> `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
  const fmtISO = (d)=> `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  // datas padrão (seg a dom)
  const dtStart = document.getElementById('dtStart');
  const dtEnd = document.getElementById('dtEnd');
  const inpWeekLabel = document.getElementById('inpWeekLabel');
  const setDefaultDates=()=>{
    const t=new Date(); const d=t.getDay(); const diff=(d+6)%7;
    const mon=new Date(t); mon.setDate(t.getDate()-diff);
    const sun=new Date(mon); sun.setDate(mon.getDate()+6);
    dtStart.value=fmtISO(mon); dtEnd.value=fmtISO(sun);
    inpWeekLabel.value=`${fmtBR(mon)} a ${fmtBR(sun)}`;
  };
  const syncLabel=()=>{
    if(!dtStart.value||!dtEnd.value) return;
    const [y1,m1,d1]=dtStart.value.split('-').map(Number);
    const [y2,m2,d2]=dtEnd.value.split('-').map(Number);
    const a=new Date(y1,m1-1,d1); const b=new Date(y2,m2-1,d2);
    inpWeekLabel.value=`${fmtBR(a)} a ${fmtBR(b)}`;
  };
  dtStart.addEventListener('change', syncLabel);
  dtEnd.addEventListener('change', syncLabel);

  // Parser com ÁREA opcional
  const detectDelimiter = (line) => {
    if (line.includes('\t')) return '\t';
    if (line.includes(';')) return ';';
    if (line.includes(',')) return ',';
    const blocks = line.trim().split(/\s{2,}/);
    if (blocks.length >= 4) return 'spaces';
    return 'spaces';
  };
  const splitRowGeneric = (row, delim) => {
    if (delim === '\t') return row.split('\t').map(s => s.replace(/^"|"$/g,'').trim());
    if (delim === 'spaces') return row.trim().split(/\s{2,}/).map(s => s.replace(/^"|"$/g,'').trim());
    const out=[]; let cur='', inQ=false;
    for (let i=0;i<row.length;i++){
      const ch=row[i];
      if (ch === '"'){ if(inQ && row[i+1]==='"'){cur+='"';i++;} else inQ=!inQ; }
      else if (ch===delim && !inQ){ out.push(cur.trim()); cur=''; }
      else cur+=ch;
    }
    out.push(cur.trim());
    return out.map(s=>s.replace(/^"|"$/g,''));
  };

  const DEFAULT_FIELDS = ["GRUPO","PLACA","POSIÇÃO SERV","ENDEREÇO","EQUIPAMENTO"];
  const canonicalizeHeader = (name) => {
    const raw = name.trim();
    const n = raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase();
    if (n === 'AREA') return 'ÁREA';
    if (n.startsWith('POSICAO')) return 'POSIÇÃO SERV';
    if (n.startsWith('POSIÇÃO')) return 'POSIÇÃO SERV';
    return raw;
  };
  const parseTable = (text) => {
    const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
    if (!lines.length) throw new Error('Nada para importar.');
    const delimiter = detectDelimiter(lines[0]);
    const firstCols = splitRowGeneric(lines[0], delimiter);

    let fields, startRow;
    const headCandRaw = firstCols.map(h => h.trim());
    const headCand = headCandRaw.map(canonicalizeHeader);
    const placaIdxHeader = headCand.findIndex(h => norm(h) === 'PLACA');

    if (placaIdxHeader !== -1) { fields = headCand; startRow = 1; }
    else {
      const firstLen = firstCols.length;
      fields = DEFAULT_FIELDS.slice();
      if (firstLen === DEFAULT_FIELDS.length + 1) fields = [...DEFAULT_FIELDS, 'ÁREA'];
      startRow = 0;
    }
    fields = fields.map(canonicalizeHeader);

    let placaIdx = fields.findIndex(h => norm(h) === 'PLACA');
    if (placaIdx === -1) placaIdx = 1;

    const rows = [];
    for (let i = startRow; i < lines.length; i++) {
      const cols = splitRowGeneric(lines[i], delimiter);
      if (!cols.length) continue;
      const plateRaw = cols[placaIdx] ?? cols[1] ?? '';
      const plate = norm(plateRaw);
      if (!plate) continue;
      const obj = {};
      for (let j = 0; j < fields.length; j++) obj[fields[j]] = cols[j] ?? '';
      rows.push({ plate, obj });
    }
    if (!rows.length) throw new Error('Nenhuma linha válida encontrada (confira a coluna PLACA/2ª coluna).');
    return { fields, rows };
  };

  // UI refs
  const txtPaste   = document.getElementById('txtPaste');
  const headRow    = document.getElementById('headRow');
  const subHeadRow = document.getElementById('subHeadRow');
  const body       = document.getElementById('body');
  const stats      = document.getElementById('stats');
  const inpFilter  = document.getElementById('inpFilter');

  // helpers de chave para duplicatas
  const makeKey = (plate, idx)=> `${plate}##${idx}`;
  const keyToPlate = (key)=> displayName[key] || key.split('##')[0];

  // adicionar semana
  function addWeek(){
    try{
      const text = txtPaste.value.trim();
      if (!text) return alert('Cole o CSV/TSV da semana.');
      const { fields, rows } = parseTable(text);

      const occ = Object.create(null);
      const data = {};
      for (const { plate, obj } of rows) {
        occ[plate] = (occ[plate] || 0) + 1;
        const idx = occ[plate];
        const key = makeKey(plate, idx);
        if (!masterPlates.includes(key)) { masterPlates.push(key); displayName[key] = plate; }
        data[key] = obj;
      }

      let label = inpWeekLabel.value.trim();
      if (!label && dtStart.value && dtEnd.value) {
        const [y1,m1,d1] = dtStart.value.split('-').map(Number);
        const [y2,m2,d2] = dtEnd.value.split('-').map(Number);
        label = `${fmtBR(new Date(y1,m1-1,d1))} a ${fmtBR(new Date(y2,m2-1,d2))}`;
      }
      if (!label) label = 'Semana';

      weeks.push({ id: String(Date.now()), label, fields, data });
      txtPaste.value='';
      render();
      persist();
    }catch(err){ console.error(err); alert(err.message||'Falha ao ler os dados.'); }
  }
  document.getElementById('btnAddWeek').addEventListener('click', addWeek);

  const removeWeek = (id)=>{ weeks = weeks.filter(w=>w.id!==id); render(); persist(); };

  // === Copiar apenas uma semana para área de transferência ===
  function copyWeekToClipboard(weekId){
    const wk = weeks.find(w => w.id === weekId);
    if (!wk) return alert('Semana não encontrada.');

    const linhas = [];

    // Cabeçalho
    linhas.push(wk.fields.join('\t'));

    // Linhas
    masterPlates.forEach(key => {
      const has = !!wk.data[key];
      const row = wk.fields.map(f => {
        if (!has) return '';
        let v = wk.data[key][f] ?? '';
        if (f.toUpperCase() === 'PLACA') v = keyToPlate(key);
        return String(v);
      });
      linhas.push(row.join('\t'));
    });

    const texto = linhas.join('\n');

    // API moderna
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(texto)
        .then(() => alert('Semana copiada para a área de transferência.'))
        .catch(err => {
          console.error(err);
          fallbackCopyText(texto);
        });
    } else {
      // fallback
      fallbackCopyText(texto);
    }
  }

  function fallbackCopyText(texto){
    const ta = document.createElement('textarea');
    ta.value = texto;
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try {
      document.execCommand('copy');
      alert('Semana copiada para a área de transferência.');
    } catch (e) {
      alert('Não foi possível copiar automaticamente. Selecione e copie manualmente.');
    }
    document.body.removeChild(ta);
  }


  // exportações (com fallback HTML)
  function downloadHTML(filename, html){
    const blob = new Blob(['\uFEFF<html><head><meta charset="UTF-8"></head><body>'+html+'</body></html>'],
      { type:'application/vnd.ms-excel' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=filename.replace(/\.xlsx$/,'')+'.xls.html'; a.click(); URL.revokeObjectURL(url);
  }
  function buildAllWeeksHTMLTable(){
    let html='<table border="1" cellspacing="0" cellpadding="4"><thead><tr>';
    weeks.forEach(w=> html+=`<th colspan="${w.fields.length+1}">${w.label}</th>`);
    html+='</tr><tr>';
    weeks.forEach(w=>{ w.fields.forEach(f=> html+=`<th>${String(f).replace(/</g,'&lt;')}</th>`); html+='<th></th>'; });
    html+='</tr></thead><tbody>';
    masterPlates.forEach(key=>{
      html+='<tr>';
      weeks.forEach(w=>{
        w.fields.forEach(f=>{
          const has=!!w.data[key]; let val=has?(w.data[key][f]??''):''; 
          if (has && f.toUpperCase()==='PLACA') val = keyToPlate(key);
          html+=`<td>${String(val).replace(/</g,'&lt;')}</td>`;
        });
        html+='<td></td>';
      });
      html+='</tr>';
    });
    html+='</tbody></table>'; return html;
  }
  function exportXLS(){
    if(!weeks.length) return alert('Nada para exportar.');
    if (typeof XLSX==='undefined') return downloadHTML('historico_placas.xlsx', buildAllWeeksHTMLTable());
    const wb=XLSX.utils.book_new();
    weeks.forEach(wk=>{
      const data=[wk.fields.slice()];
      masterPlates.forEach(key=>{
        const has=!!wk.data[key];
        const row=wk.fields.map(f=>{
          if(!has) return ''; const v=wk.data[key][f]??''; 
          return (f.toUpperCase()==='PLACA')? keyToPlate(key): v;
        });
        data.push(row);
      });
      const ws=XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, wk.label.substring(0,31));
    });
    XLSX.writeFile(wb,'historico_placas.xlsx');
  }
  function exportCSV(){
    if(!weeks.length) return alert('Nada para exportar.');
    const head=[]; weeks.forEach(w=> w.fields.forEach(f=> head.push(`${w.label} – ${f}`)));
    const rows=[head];
    masterPlates.forEach(key=>{
      const row=[];
      weeks.forEach(w=>{
        w.fields.forEach(f=>{
          const has=!!w.data[key]; let v=has?(w.data[key][f]??''):''; 
          if(has && f.toUpperCase()==='PLACA') v=keyToPlate(key);
          row.push(String(v));
        });
      });
      rows.push(row);
    });
    const csv=rows.map(r=> r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='historico_placas_completo.csv'; a.click(); URL.revokeObjectURL(url);
  }
  document.getElementById('btnExportCsv').addEventListener('click', exportCSV);
  document.getElementById('btnExportXls').addEventListener('click', exportXLS);

  document.getElementById('btnReset').addEventListener('click', ()=>{
    if(!confirm(`Limpar todos os dados da empresa "${current}"?`)) return;
    masterPlates=[]; weeks=[]; displayName={}; render(); persist();
  });

  inpFilter.addEventListener('input', e=>{ filter = norm(e.target.value); render(); });

  // renderização da grade
  function render(){
    headRow.innerHTML=''; subHeadRow.innerHTML=''; body.innerHTML='';
    weeks.forEach((w, wi)=>{
      const th = document.createElement('th');
      th.colSpan = w.fields.length + 1;
      const wrap = document.createElement('div');
      wrap.className = 'weekhead';

      // Label editável
      const input = document.createElement('input');
      input.type = 'text';
      input.value = w.label;
      input.addEventListener('input', e => {
        w.label = e.target.value;
        persist();
      });

      // Botões
      const csvBtn=document.createElement('button');
      csvBtn.className='btn';
      csvBtn.textContent='CSV';
      csvBtn.title='Exportar só esta semana (CSV)';
      csvBtn.addEventListener('click', ()=> exportWeekCSV(w.id));

      const xlsBtn=document.createElement('button');
      xlsBtn.className='btn';
      xlsBtn.textContent='XLS';
      xlsBtn.title='Exportar só esta semana (Excel)';
      xlsBtn.addEventListener('click', ()=> exportWeekXLS(w.id));

      const copyBtn=document.createElement('button');
      copyBtn.className='btn';
      copyBtn.textContent='Copiar';
      copyBtn.title='Copiar só esta semana para a área de transferência';
      copyBtn.addEventListener('click', ()=> copyWeekToClipboard(w.id));

      const rm=document.createElement('button');
      rm.className='btn';
      rm.textContent='×';
      rm.title='Remover semana';
      rm.addEventListener('click', ()=> removeWeek(w.id));

      // Adiciona botões em ordem
      wrap.append(input, csvBtn, xlsBtn, copyBtn, rm);
      th.appendChild(wrap);

      // AGORA SIM adiciona na linha de cabeçalhos
      headRow.appendChild(th);

      w.fields.forEach((f,j)=>{
        const th2=document.createElement('th'); th2.textContent=f; th2.classList.add('wk-sub',`wk-${wi}`); if(j===0) th2.classList.add('sepL');
        const k=f.toUpperCase();
        if(k.includes('GRUPO')) th2.classList.add('col-grupo');
        else if(k==='PLACA') th2.classList.add('col-placa');
        else if(k.includes('POSI')) th2.classList.add('col-posicao');
        else if(k.includes('END')) th2.classList.add('col-endereco');
        else if(k.includes('EQUI')) th2.classList.add('col-equip');
        else if(k.includes('ÁREA')||k.includes('AREA')) th2.classList.add('col-area');
        subHeadRow.appendChild(th2);
      });
      const gutter=document.createElement('th'); gutter.className='gutter'; subHeadRow.appendChild(gutter);
    });

    const keys = filter ? masterPlates.filter(k=> (displayName[k]||k).includes(filter)) : masterPlates.slice();
    keys.forEach(key=>{
      const tr=document.createElement('tr');
      weeks.forEach((w, wi)=>{
        w.fields.forEach((f,j)=>{
          const td=document.createElement('td'); td.classList.add('wk',`wk-${wi}`); if(j===0) td.classList.add('sepL');
          const K=f.toUpperCase();
          if(K.includes('GRUPO')) td.classList.add('col-grupo');
          else if(K==='PLACA') td.classList.add('col-placa');
          else if(K.includes('POSI')) td.classList.add('col-posicao');
          else if(K.includes('END')) td.classList.add('col-endereco');
          else if(K.includes('EQUI')) td.classList.add('col-equip');
          else if(K.includes('ÁREA')||K.includes('AREA')) td.classList.add('col-area');

          const has=!!w.data[key]; let val=has?(w.data[key][f]??''):''; 
          if(has && K==='PLACA') val = keyToPlate(key);
          td.textContent=val; tr.appendChild(td);
        });
        const gutterTd=document.createElement('td'); gutterTd.className='gutter'; tr.appendChild(gutterTd);
      });
      body.appendChild(tr);
    });

    stats.textContent = `Empresa: ${current} • Linhas: ${masterPlates.length} • Semanas: ${weeks.length}`;
  }

  function exportWeekCSV(weekId){
    const wk=weeks.find(w=>w.id===weekId); if(!wk) return alert('Semana não encontrada.');
    const head=wk.fields.slice(); const rows=[head];
    masterPlates.forEach(key=>{
      const has=!!wk.data[key];
      rows.push(wk.fields.map(f=>{
        if(!has) return '';
        const v=wk.data[key][f]??''; return (f.toUpperCase()==='PLACA')? keyToPlate(key): v;
      }));
    });
    const csv=rows.map(r=> r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=`semana_${wk.label.replace(/[\\/:*?"<>|]+/g,'_')}.csv`; a.click(); URL.revokeObjectURL(url);
  }
  function exportWeekXLS(weekId){
    const wk=weeks.find(w=>w.id===weekId); if(!wk) return alert('Semana não encontrada.');
    if(typeof XLSX==='undefined'){ 
      let html='<table border="1" cellspacing="0" cellpadding="4"><thead><tr>';
      wk.fields.forEach(f=> html+=`<th>${String(f).replace(/</g,'&lt;')}</th>`); html+='</tr></thead><tbody>';
      masterPlates.forEach(key=>{
        const has=!!wk.data[key]; html+='<tr>';
        wk.fields.forEach(f=>{
          let v = has? (wk.data[key][f]??'') : '';
          if (has && f.toUpperCase()==='PLACA') v=keyToPlate(key);
          html+=`<td>${String(v).replace(/</g,'&lt;')}</td>`;
        });
        html+='</tr>';
      });
      html+='</tbody></table>';
      return downloadHTML(`semana_${wk.label}.xlsx`, html);
    }
    const data=[wk.fields.slice()];
    masterPlates.forEach(key=>{
      const has=!!wk.data[key];
      data.push(wk.fields.map(f=>{
        if(!has) return ''; const v=wk.data[key][f]??''; 
        return (f.toUpperCase()==='PLACA')? keyToPlate(key): v;
      }));
    });
    const wb=XLSX.utils.book_new(); const ws=XLSX.utils.aoa_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, wk.label.substring(0,31));
    XLSX.writeFile(wb, `semana_${wk.label.replace(/[\\/:*?"<>|]+/g,'_')}.xlsx`);
  }

  // iniciar
  let masterPlates, weeks, displayName; // definidos em loadStateFor
  let filter = ''; // evita ReferenceError em render()
  loadStateFor(current);
  renderTabs();
  render();
  // datas padrão
  (function setDefaultsIIFE(){
    const t=new Date(); const d=t.getDay(); const diff=(d+6)%7;
    const mon=new Date(t); mon.setDate(t.getDate()-diff);
    const sun=new Date(mon); sun.setDate(mon.getDate()+6);
    dtStart.value=fmtISO(mon); dtEnd.value=fmtISO(sun);
    inpWeekLabel.value=`${fmtBR(mon)} a ${fmtBR(sun)}`;
  })();

})();
</script>
</body>
</html>
